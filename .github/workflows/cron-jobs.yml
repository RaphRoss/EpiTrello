name: Scheduled Tasks

on:
  schedule:
    # Run security audit daily at 2 AM UTC
    - cron: '0 2 * * *'
    # Run backup weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  security-audit:
    name: Daily Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Audit backend dependencies
        working-directory: ./backend
        run: |
          npm ci
          npm audit --audit-level=moderate --json > backend-audit.json || true

      - name: Audit frontend dependencies
        working-directory: ./frontend
        run: |
          npm ci
          npm audit --audit-level=moderate --json > frontend-audit.json || true

      - name: Check for critical vulnerabilities
        run: |
          if grep -q '"severity":"critical"' backend/backend-audit.json frontend/frontend-audit.json; then
            echo "‚ùå Critical vulnerabilities found!"
            exit 1
          fi

      - name: Create issue if vulnerabilities found
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Security vulnerabilities detected',
              body: 'Daily security audit found vulnerabilities. Please review and update dependencies.',
              labels: ['security', 'automated']
            });

  database-backup:
    name: Weekly Database Backup
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 3 * * 0'

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Backup database
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'EOF'
            DATE=$(date +%Y%m%d_%H%M%S)
            docker exec epitrello-postgres pg_dump -U epitrello epitrello > /backups/epitrello_$DATE.sql
            gzip /backups/epitrello_$DATE.sql
            
            # Keep only last 4 weeks of backups
            find /backups -name "epitrello_*.sql.gz" -mtime +28 -delete
          EOF

      - name: Notify backup completion
        if: always()
        continue-on-error: true
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: ${{ job.status }}
          text: 'Weekly database backup: ${{ job.status }}'

  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Delete old artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '30 days'
          skip-recent: 5

  docker-cleanup:
    name: Docker Registry Cleanup
    runs-on: ubuntu-latest

    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Cleanup old images
        run: |
          # Keep only last 10 tags
          echo "Cleaning up old Docker images..."
          # This would require additional tooling or scripts
